name: Deploy to TESTING Caprovers

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-testing:
    runs-on: ubuntu-latest
    environment: Testing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display deployment info
        run: |
          echo "Starting Testing deployment..."
          echo "Environment: Testing"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: Validate TESTING secrets
        run: |
          if [ -z "${{ secrets.CAPROVER_TESTING_WEBHOOK }}" ]; then
            echo "CAPROVER_TESTING_WEBHOOK secret is missing"; exit 1; fi
          if [ -z "${{ secrets.CAPROVER_TESTING_DOMAIN }}" ]; then
            echo "CAPROVER_TESTING_DOMAIN secret is missing"; exit 1; fi
          if [ -z "${{ secrets.CAPROVER_TESTING_APP_NAME }}" ]; then
            echo "CAPROVER_TESTING_APP_NAME secret is missing"; exit 1; fi
          echo "All required TESTING secrets are configured"

      - name: Get current commit for rollback
        id: current-commit
        run: |
          CURRENT_COMMIT=$(git rev-parse HEAD~1)
          echo "commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT

      - name: Start deployment tracking
        uses: bobheadxi/deployments@v1
        id: deployment
        with:
          token: ${{ github.token }}
          step: start
          env: TESTING

      - name: Deploy via CapRover Webhook
        id: deploy
        run: |
          WEBHOOK_URL="${{ secrets.CAPROVER_TESTING_WEBHOOK }}"
          APP_NAME="${{ secrets.CAPROVER_TESTING_APP_NAME }}"
          DOMAIN="${{ secrets.CAPROVER_TESTING_DOMAIN }}"

          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "DOMAIN=$DOMAIN" >> $GITHUB_ENV

          response=$(curl -s -X POST "$WEBHOOK_URL" -w "HTTPSTATUS:%{http_code}")
          http_code=$(echo "$response" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')

          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "DEPLOY_SUCCESS=true" >> $GITHUB_OUTPUT
          else
            echo "DEPLOY_SUCCESS=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Wait for build and deployment
        if: steps.deploy.outputs.DEPLOY_SUCCESS == 'true'
        run: sleep 240

      - name: Post-deployment health check
        id: health-check
        if: steps.deploy.outputs.DEPLOY_SUCCESS == 'true'
        run: |
          APP_URL="https://${{ env.APP_NAME }}.${{ env.DOMAIN }}"
          for i in {1..20}; do
            if curl -s -f "$APP_URL/health" >/dev/null; then
              echo "HEALTH_CHECK_PASSED=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 30
          done
          echo "HEALTH_CHECK_PASSED=false" >> $GITHUB_OUTPUT
          exit 1

      - name: Rollback on failure
        if: failure() || steps.deploy.outputs.DEPLOY_SUCCESS == 'false' || steps.health-check.outputs.HEALTH_CHECK_PASSED == 'false'
        run: |
          git checkout ${{ steps.current-commit.outputs.commit }}
          curl -s -X POST "${{ secrets.CAPROVER_TESTING_WEBHOOK }}" >/dev/null || true
          exit 1

      - name: Update deployment status
        if: always()
        uses: bobheadxi/deployments@v1
        with:
          token: ${{ github.token }}
          step: finish
          env: ${{ steps.deployment.outputs.env }}
          status: ${{ job.status }}
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}

      - name: Deployment success
        if: success()
        run: |
          echo "TESTING deployment completed successfully!"
          echo "URL: https://${{ env.APP_NAME }}.${{ env.DOMAIN }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
