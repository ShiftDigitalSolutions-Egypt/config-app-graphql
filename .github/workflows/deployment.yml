name: Deploy to TESTING Caprover

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy-TESTING:
    runs-on: ubuntu-latest
    environment: Testing
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Display deployment info
        run: |
          echo "ğŸš€ Starting Testing deployment..."
          echo "ğŸ“¦ Environment: Testing"
          echo "ğŸŒ¿ Branch: main"
          echo "ğŸ“‹ Commit: ${{ github.sha }}"
      
      - name: Validate TESTING secrets
        run: |
          echo "ğŸ” Validating required TESTING secrets..."
          
          if [ -z "${{ secrets.CAPROVER_TESTING_WEBHOOK }}" ]; then
            echo "âŒ CAPROVER_TESTING_WEBHOOK secret is missing"
            exit 1
          fi
          echo "âœ… TESTING webhook secret found"
          
          if [ -z "${{ secrets.CAPROVER_TESTING_DOMAIN }}" ]; then
            echo "âŒ CAPROVER_TESTING_DOMAIN secret is missing"
            exit 1
          fi
          echo "âœ… TESTING domain secret found"
          
          if [ -z "${{ secrets.CAPROVER_TESTING_APP_NAME }}" ]; then
            echo "âŒ CAPROVER_TESTING_APP_NAME secret is missing"
            exit 1
          fi
          echo "âœ… TESTING app name secret found"
          
          echo "âœ… All required TESTING secrets are configured"
      
      - name: Get current commit for rollback
        id: current-commit
        run: |
          CURRENT_COMMIT=$(git rev-parse HEAD~1)
          echo "commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          echo "ğŸ’¾ Rollback commit ready: $CURRENT_COMMIT"
      
      - name: Start deployment tracking
        uses: bobheadxi/deployments@v1
        id: deployment
        with:
          token: ${{ github.token }}
          step: start
          env: TESTING
      
      - name: Deploy via CapRover Webhook
        id: deploy
        run: |
          echo "ğŸš¢ Triggering CapRover TESTING deployment via webhook..."
          
          WEBHOOK_URL="${{ secrets.CAPROVER_TESTING_WEBHOOK }}"
          APP_NAME="${{ secrets.CAPROVER_TESTING_APP_NAME }}"
          DOMAIN="${{ secrets.CAPROVER_TESTING_DOMAIN }}"
          
          echo "ğŸ­ Using TESTING environment"
          echo "ğŸ“± App: $APP_NAME"
          echo "ğŸŒ Domain: $DOMAIN"
          
          # Mask the full URL for security
          MASKED_URL=$(echo "$WEBHOOK_URL" | sed 's|://.*@|://***@|' | sed 's|/api/.*|/api/***|')
          echo "ğŸ“¡ Webhook URL: $MASKED_URL"
          
          # Store environment details for later steps
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "DOMAIN=$DOMAIN" >> $GITHUB_ENV
          
          # Validate webhook URL format
          if [[ ! "$WEBHOOK_URL" =~ ^https?:// ]]; then
            echo "âŒ Invalid webhook URL format: $WEBHOOK_URL"
            exit 1
          fi
          
          # Test DNS resolution first
          echo "ğŸ” Testing DNS resolution..."
          HOSTNAME=$(echo "$WEBHOOK_URL" | sed 's|^https\?://||' | sed 's|/.*||' | sed 's|:.*||')
          echo "ğŸŒ Testing hostname: $HOSTNAME"
          
          if ! nslookup "$HOSTNAME" > /dev/null 2>&1; then
            echo "âŒ DNS resolution failed for: $HOSTNAME"
            echo "ğŸ”§ Please check if the webhook URL is correct"
            exit 1
          fi
          echo "âœ… DNS resolution successful"
          
          # Trigger deployment with better error handling
          echo "ğŸ“¤ Sending deployment request..."
          
          # Use curl with more verbose error reporting
          if ! response=$(curl -s -X POST "$WEBHOOK_URL" -w "HTTPSTATUS:%{http_code}" --connect-timeout 30 --max-time 60 2>&1); then
            curl_exit_code=$?
            echo "âŒ Curl command failed with exit code: $curl_exit_code"
            case $curl_exit_code in
              6) echo "ğŸš¨ Could not resolve host. Check webhook URL and DNS." ;;
              7) echo "ğŸš¨ Failed to connect to host. Check network and firewall." ;;
              28) echo "ğŸš¨ Operation timeout. The server took too long to respond." ;;
              *) echo "ğŸš¨ Unknown curl error. Check webhook URL and network connectivity." ;;
            esac
            exit 1
          fi
          
          # Parse response
          http_code=$(echo "$response" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          body=$(echo "$response" | sed -e 's/HTTPSTATUS\:.*//g')
          
          echo "ğŸ“Š HTTP Status: $http_code"
          echo "ğŸ“„ Response: $body"
          
          # Validate HTTP status code
          if [[ ! "$http_code" =~ ^[0-9]+$ ]]; then
            echo "âŒ Invalid HTTP status code received: '$http_code'"
            echo "ğŸ”§ This might indicate a malformed webhook URL or network issue"
            exit 1
          fi
          
          # Check if deployment was successful
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "âœ… Deployment webhook triggered successfully"
            echo "DEPLOY_SUCCESS=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Deployment webhook failed with status: $http_code"
            echo "DEPLOY_SUCCESS=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Wait for build and deployment
        if: steps.deploy.outputs.DEPLOY_SUCCESS == 'true'
        run: |
          echo "â±ï¸ CapRover deployment initiated..."
          echo "ğŸ”„ Proceeding to health checks immediately"
          echo "âœ… Moving to next step"
      
      - name: Post-deployment health check
        id: health-check
        if: steps.deploy.outputs.DEPLOY_SUCCESS == 'true'
        run: |
          echo "ğŸ” Performing post-deployment health check..."
          APP_URL="https://${{ env.APP_NAME }}.${{ env.DOMAIN }}"
          echo "ğŸŒ Health check URL: $APP_URL/health"
          
          START_TIME=$(date +%s)
          echo "ğŸ• Health check started at: $(date)"
          
          for i in {1..20}; do
            echo "ğŸ¥ Health check attempt $i of 20..."
            
            if response=$(curl -s -f -w "HTTPSTATUS:%{http_code}" "$APP_URL/health" 2>/dev/null); then
              http_code=$(echo "$response" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
              
              if [ "$http_code" -eq 200 ]; then
                echo "âœ… Health check passed! HTTP $http_code"
                echo "â±ï¸ Total wait time: $(($(date +%s) - START_TIME)) seconds"
                echo "HEALTH_CHECK_PASSED=true" >> $GITHUB_OUTPUT
                break
              fi
            fi
            
            if [ $i -eq 20 ]; then
              echo "âŒ Post-deployment health check failed after 20 attempts"
              echo "HEALTH_CHECK_PASSED=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            echo "â³ Waiting 30 seconds before next attempt..."
            sleep 30
          done
      
      - name: Rollback on failure
        if: failure() || steps.deploy.outputs.DEPLOY_SUCCESS == 'false' || steps.health-check.outputs.HEALTH_CHECK_PASSED == 'false'
        run: |
          echo "ğŸ”„ Deployment or health check failed. Initiating rollback..."
          echo "ğŸ“ Rolling back to commit: ${{ steps.current-commit.outputs.commit }}"
          
          git checkout ${{ steps.current-commit.outputs.commit }}
          
          WEBHOOK_URL="${{ secrets.CAPROVER_TESTING_WEBHOOK }}"
          
          echo "ğŸš¨ Triggering rollback deployment via webhook..."
          rollback_response=$(curl -s -X POST "$WEBHOOK_URL" -w "HTTPSTATUS:%{http_code}")
          rollback_http_code=$(echo $rollback_response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          
          if [ "$rollback_http_code" -eq 200 ] || [ "$rollback_http_code" -eq 201 ]; then
            echo "âœ… Rollback deployment triggered successfully"
          else
            echo "âŒ Rollback deployment failed with status: $rollback_http_code"
          fi
          
          echo "ğŸ”„ Rollback completed"
          exit 1
      
      - name: Update deployment status
        if: always()
        uses: bobheadxi/deployments@v1
        with:
          token: ${{ github.token }}
          step: finish
          env: ${{ steps.deployment.outputs.env }}
          status: ${{ job.status }}
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
      
      - name: Deployment success
        if: success()
        run: |
          echo "ğŸ‰ TESTING deployment completed successfully!"
          echo "âœ… Application is healthy and accessible"
          echo "ğŸŒ URL: https://${{ env.APP_NAME }}.${{ env.DOMAIN }}"
          echo "ğŸ“Š Environment: TESTING"
          echo "ğŸŒ¿ Branch: TESTINGFacelift"
          echo "ğŸ“‹ Commit: ${{ github.sha }}"
